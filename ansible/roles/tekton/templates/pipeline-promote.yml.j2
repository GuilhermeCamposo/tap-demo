apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  annotations:
  labels:
    backstage.io/kubernetes-id: {{ pipeline_app_name }}
    rht-gitops.com/janus-argocd: {{ pipeline_app_name }}-dev-build
    type: pipeline
  name: {{ pipeline_app_name }}-promote
spec:
  params:
  - description: The git repository used in promotion
    name: git-repo-url
    type: string
  - description: The revision to be promoted
    name: git-revision
    type: string
  - default: {{ pipeline_source_image }}
    description: source image to promote
    name: source-image
    type: string
  - default: {{ pipeline_preprod_image }}
    description: destination image to promote to
    name: destination-image
    type: string
  - default: latest
    name: source-image-tag
    type: string
  - default: latest
    name: destination-image-tag
    type: string
  - name: namespace
    type: string
  - description: The hostname of the git instance
    name: git-host
    type: string
  - description: The owner of the repo
    name: git-owner
    type: string
  - description: The name of the component
    name: component-id
    type: string
  - description: Common password used in demo
    name: common-password-secret
    type: string
  - description: ArgoCD host
    name: argocd-host
    type: string
  - name: policy-configuration
    type: string
  - name: rekor-host
    type: string
  - name: tuf_mirror
    type: string
  tasks:
  - name: verify-enterprise-contract
    params:
    - name: IMAGE
      value: $(params.source-image):$(params.source-image-tag)
    - name: COMPONENT_ID
      value: {{ pipeline_app_name }}
    - name: REKOR_HOST
      value: $(params.rekor-host)
    - name: POLICY_CONFIGURATION
      value: $(params.policy-configuration)
    - name: TUF_MIRROR
      value: $(params.tuf_mirror)
    - name: CI_PROJECT_URL
      value: $(params.git-repo-url)
    - name: GIT_REVISION
      value: $(params.git-revision)
    taskRef:
      kind: Task
      name: verify-enterprise-contract
  - name: quay-tag-promote
    params:
    - name: srcImageURL
      value: docker://$(params.source-image):$(params.source-image-tag)
    - name: destImageURL
      value: docker://$(params.source-image):$(params.destination-image-tag)
    - name: srcTLSverify
      value: "false"
    - name: destTLSverify
      value: "false"
    runAfter:
    - verify-enterprise-contract
    taskRef:
      kind: ClusterTask
      name: skopeo-copy
    workspaces:
    - name: images-url
      workspace: images-url
  - name: patch-deployment
    params:
    - name: namespace
      value: $(params.namespace)
    - name: git-host
      value: $(params.git-host)
    - name: git-owner
      value: $(params.git-owner)
    - name: component-id
      value: $(params.component-id)
    - name: common-password-secret
      value: $(params.common-password-secret)
    - name: image-tag
      value: $(params.destination-image-tag)
    - name: argocd-host
      value: $(params.argocd-host)
    runAfter:
    - quay-tag-promote
    taskRef:
      kind: Task
      name: update-deployment
  workspaces:
  - name: images-url
